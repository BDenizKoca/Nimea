<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nimea CMS - Auth</title>
</head>
<body>
  <script>
    console.log("Auth callback handler loaded");
    // OAuth callback handler for GitHub
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const state = params.get('state');
    
    // Debugging output
    console.log("Auth params received:", { code: code ? "present" : "missing", state: state ? "present" : "missing" });
    
    if (code) {
      // Display a status message
      document.body.innerHTML = "<h3>Authorization successful. Processing...</h3>";
      
      try {
        // Allow any origin to receive the message (will be restricted by browser)
        const targetOrigin = window.opener ? "*" : "https://bdenizkoca.github.io";
        
        // Send the authorization code back to the CMS
        window.opener.postMessage(
          {
            type: 'authorization-github',
            payload: { code, state }
          },
          targetOrigin
        );
        
        console.log("Auth message posted to parent");
        
        // Add a delay before closing to ensure message is processed
        setTimeout(() => {
          document.body.innerHTML += "<p>Completing authentication. You can close this window if it doesn't close automatically.</p>";
          window.close();
        }, 1500);
      } catch (error) {
        console.error("Error posting message:", error);
        document.body.innerHTML = "<h3>Error sending authorization to CMS.</h3><p>Please close this window and try again.</p>";
      }
    } else {
      // Handle error case
      const error = params.get('error');
      const errorDescription = params.get('error_description');
      
      // Display the error for debugging
      document.body.innerHTML = `<h3>Authentication Error</h3><p>${error || 'unknown_error'}: ${errorDescription || 'An unknown error occurred'}</p>`;
      
      try {
        window.opener.postMessage(
          {
            type: 'authorization-github',
            error: error || 'unknown_error',
            error_description: errorDescription || 'An unknown error occurred'
          },
          "*"
        );
        console.log("Error message posted to parent");
      } catch (e) {
        console.error("Error posting error message:", e);
      }
      
      // Add a delay before closing
      setTimeout(() => {
        window.close();
      }, 3000);
    }
  </script>
</body>
</html>