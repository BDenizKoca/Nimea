<!DOCTYPE html>
<html lang="{{ lang or 'tr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or name }} | Nimea</title>
    <link rel="stylesheet" href="{{ '/css/style.css' | url }}">
    <!-- Theme color: provide light/dark variants; unsupported browsers safely ignore -->
    <meta name="theme-color" content="#8b4513" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#2e2216" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href="{{ '/manifest.webmanifest' | url }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ '/images/icons/icon-32.png' | url }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ '/images/icons/icon-180.png' | url }}">
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <div class="container">
        <header class="site-header">
            <div class="header-bar">
                <div class="nav-left">
                    {% if lang == 'en' %}
                    <a href="{{ '/en/' | url }}" class="{% if page.url == '/en/' %}active{% endif %}">Home</a>
                    <a href="{{ '/en/wiki/' | url }}" class="{% if page.url == '/en/wiki/' or (page.url | slice(0,9) == '/en/wiki/') %}active{% endif %}">Wiki</a>
                    <a href="{{ '/en/map/' | url }}" class="{% if page.url == '/en/map/' or (page.url | slice(0,8) == '/en/map/') %}active{% endif %}">Map</a>
                    {% else %}
                    <a href="{{ '/' | url }}" class="{% if page.url == '/' %}active{% endif %}">Ana Sayfa</a>
                    <a href="{{ '/wiki/' | url }}" class="{% if page.url == '/wiki/' or (page.url | slice(0,6) == '/wiki/') %}active{% endif %}">Külliyat</a>
                    <a href="{{ '/map/' | url }}" class="{% if page.url == '/map/' or (page.url | slice(0,5) == '/map/') %}active{% endif %}">Harita</a>
                    {% endif %}
                </div>
                <div class="search-mount"></div>
                <div class="lang-switch">
                    {% if lang == 'en' %}
                      <a href="{{ page.url | replace('/en', '') }}">TR</a>
                    {% else %}
                      <a href="{{ '/en' + page.url }}">EN</a>
                    {% endif %}
                </div>
            </div>
        </header>
        <main>
            {% if cover_image %}
            <div class="cover-image">
                <img src="{{ cover_image | url }}" alt="{{ title or name }} için kapak görseli" />
            </div>
            {% endif %}
            
            {% if portrait_image %}
            <div class="portrait-image">
                <img src="{{ portrait_image | url }}" alt="{{ title or name }} portresi" />
            </div>
            {% endif %}
            
            {% if name %}
            <div class="entry-actions btn-row" style="justify-content:center;">
                {% if map_id %}
                <a href="{% if lang == 'en' %}{{ '/en/map/?focus=' + map_id | url }}{% else %}{{ '/map/?focus=' + map_id | url }}{% endif %}" class="btn btn--accent show-on-map-btn">
                    {% if lang == 'en' %}Show on Map{% else %}Haritada Göster{% endif %}
                </a>
                {% endif %}
            </div>
            {% endif %}
            
            {{ content | safe }}

            {% if name %}
            <div class="entry-actions btn-row" style="justify-content:center; margin-top: 1rem;">
                <button type="button" class="btn btn--accent share-btn" data-title="{{ name }}" data-summary="{{ summary }}">
                    {% if lang == 'en' %}Share{% else %}Paylaş{% endif %}
                </button>
            </div>
            {% endif %}
        </main>
    </div>
    
        <script>
      // Handle Netlify Identity redirects for email confirmation
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
            <!-- Admin link moved to homepage CTA; no header Admin link. -->
        <script>
            // Lightweight share handler with clipboard fallback and toast
            document.addEventListener('DOMContentLoaded', () => {
                const btn = document.querySelector('.share-btn');
                if (!btn) return;
                const makeToast = (msg) => {
                    let t = document.querySelector('.toast');
                    if (!t) {
                        t = document.createElement('div');
                        t.className = 'toast';
                        document.body.appendChild(t);
                    }
                    t.textContent = msg;
                    t.classList.add('visible');
                    setTimeout(() => t.classList.remove('visible'), 2000);
                };
                btn.addEventListener('click', async () => {
                    const title = btn.getAttribute('data-title') || document.title;
                    const text = btn.getAttribute('data-summary') || '';
                    const url = window.location.href;
                    try {
                        if (navigator.share) {
                            await navigator.share({ title, text, url });
                        } else if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(url);
                            makeToast('{% if lang == 'en' %}Link copied{% else %}Bağlantı kopyalandı{% endif %}');
                        } else {
                            // Legacy fallback
                            const ta = document.createElement('textarea');
                            ta.value = url;
                            document.body.appendChild(ta);
                            ta.select();
                            try { document.execCommand('copy'); } catch {}
                            document.body.removeChild(ta);
                            makeToast('{% if lang == 'en' %}Link copied{% else %}Bağlantı kopyalandı{% endif %}');
                        }
                    } catch (err) {
                        makeToast('{% if lang == 'en' %}Share failed{% else %}Paylaşım başarısız{% endif %}');
                        console.error('Share failed', err);
                    }
                });
            });
        </script>

    <!-- Görsel Önizleme Modalı -->
    <div class="image-modal-overlay" id="image-modal-overlay">
        <img src="" alt="Büyütülmüş görüntü" class="image-modal-content" id="image-modal-content">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.querySelector('main');
            const modalOverlay = document.getElementById('image-modal-overlay');
            const modalImage = document.getElementById('image-modal-content');

            if (mainContent && modalOverlay && modalImage) {
                mainContent.addEventListener('click', (event) => {
                    // Check if the clicked element is an image and not inside a link
                    if (event.target.tagName === 'IMG' && !event.target.closest('a')) {
                        // Exclude cover and portrait images from being modal
                        if (event.target.closest('.cover-image') || event.target.closest('.portrait-image')) {
                            return;
                        }
                        
                        modalImage.src = event.target.src;
                        modalOverlay.classList.add('visible');
                    }
                });

                modalOverlay.addEventListener('click', () => {
                    modalOverlay.classList.remove('visible');
                    // Optional: clear src after fade out to prevent showing old image briefly
                    setTimeout(() => { modalImage.src = ''; }, 300);
                });
            }
        });
    </script>
    <script src="/js/search.js" defer></script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').catch(console.error);
                });
            }
        </script>
</body>
</html>
