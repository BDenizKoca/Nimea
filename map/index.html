<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nimea Etkileşimli Harita</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;700&family=EB+Garamond:wght@400;500;700&display=swap&subset=latin-ext">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="/map/style.css">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-180.png">
    <!-- Theme color variants for better UI on supported browsers -->
    <meta name="theme-color" content="#8b4513" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#2e2216" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <header class="map-header">
        <nav class="map-nav">
            <a href="../" class="nav-link">Ana Sayfa</a>
            <a href="../wiki/" class="nav-link">Külliyat</a>
            <h1 class="map-title">Nimea Etkileşimli Harita</h1>
            <div class="lang-switch">
                <a href="../en/map/">EN</a>
            </div>
            <button id="logout-btn" class="wiki-link">Çıkış yap</button>
            <button id="pwa-install" class="wiki-link">Uygulamayı Yükle</button>
        </nav>
    </header>
    
    <div id="map"></div>

    <div class="map-legend hidden" id="map-legend" role="region" aria-label="Harita Açıklamaları">
        <h4>Açıklamalar</h4>
        <ul>
            <li><span class="legend-swatch legend-road"></span> Yol</li>
            <li><span class="legend-swatch legend-difficult"></span> Zorlu Arazi</li>
            <li><span class="legend-swatch legend-unpassable"></span> Geçilmez Arazi</li>
            <li><span class="legend-swatch legend-route"></span> Rota</li>
        </ul>
    <div class="legend-note">Ölçek: 115 px = 50 km</div>
    </div>

    <!-- Overlay segmented control will appear through existing container -->

    <div class="sidebar left-sidebar" id="route-sidebar">
        <button id="close-route-sidebar" class="sidebar-close-btn">&times;</button>
    <h2>Rota Planlayıcı</h2>
        <div class="route-options" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="sea-travel-checkbox" style="margin-right: 8px; cursor: pointer;">
                <span>Deniz Yolu Kullan</span>
            </label>
        </div>
        <div id="route-stops"></div>
        <div id="route-summary"></div>
    </div>

    <div class="sidebar right-sidebar" id="info-sidebar">
        <button id="close-info-sidebar" aria-label="Kapat">&times;</button>
        <div id="info-content"></div>
    </div>

    <!-- DM Mode Marker Creation Form -->
    <div class="modal hidden" id="marker-creation-modal">
        <div class="modal-content">
            <h3>Yeni İşaret Oluştur</h3>
            <form id="marker-form">
                <input type="hidden" id="marker-lat">
                <input type="hidden" id="marker-lng">
                <div class="form-group">
                    <label for="marker-name-tr">Ad (TR) *</label>
                    <input type="text" id="marker-name-tr" name="marker-name-tr" required>
                </div>
                <div class="form-group">
                    <label for="marker-name-en">Name (EN)</label>
                    <input type="text" id="marker-name-en" name="marker-name-en">
                </div>
                
                <div class="form-group">
                    <label for="marker-id">Kimlik (ID) *</label>
                    <input type="text" id="marker-id" name="marker-id" required>
                    <small>İsimden otomatik üretilir; düzenleyebilirsin</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-type">Tür</label>
                    <select id="marker-type" name="marker-type">
                        <option value="city">Şehir</option>
                        <option value="town">Kasaba</option>
                        <option value="village">Köy</option>
                        <option value="fortress">Hisar</option>
                        <option value="ruin">Harabe</option>
                        <option value="landmark">Anıt</option>
                        <option value="dungeon">Zindan</option>
                        <option value="other">Diğer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon">Özel Simge</label>
                    <div class="icon-input-container">
                        <input type="text" id="marker-icon" name="marker-icon" placeholder="Varsayılan için boş bırak" maxlength="10">
                        <!-- Emoji önerileri kaldırıldı -->
                    </div>
                    <small>İstersen özel bir simge karakteri yazabilirsin</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon-url">Veya Özel Görsel URL</label>
                    <input type="url" id="marker-icon-url" name="marker-icon-url" placeholder="https://example.com/icon.png">
                    <small>PNG/JPG bir simge URL’si kullanabilirsin (yukarıdaki değerin yerine geçer)</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-faction-tr">Cemiyet/Devlet (TR)</label>
                    <input type="text" id="marker-faction-tr" name="marker-faction-tr" placeholder="Aurelius İmparatorluğu">
                </div>
                <div class="form-group">
                    <label for="marker-faction-en">Faction (EN)</label>
                    <input type="text" id="marker-faction-en" name="marker-faction-en" placeholder="Empire of Aurelius">
                </div>

                <div class="form-group">
                    <label for="marker-summary-tr">Özet (TR) *</label>
                    <textarea id="marker-summary-tr" name="marker-summary-tr" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="marker-summary-en">Summary (EN)</label>
                    <textarea id="marker-summary-en" name="marker-summary-en" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="marker-wiki-slug">Wiki Kısa Ad (Slug)</label>
                    <input type="text" id="marker-wiki-slug" name="marker-wiki-slug" placeholder="Optional: e.g., empire-of-aurelius">
                    <small>Verilirse doğrudan /wiki/&lt;slug&gt;/ adresine bağlanır; aksi hâlde otomatik üretilir.</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-image-url">Görsel URL Ekle</label>
                    <div class="image-input-row">
                        <input type="url" id="marker-image-url" placeholder="https://... veya images/ornek.jpg" class="flex-1" />
                        <button type="button" id="add-image-url">Ekle</button>
                    </div>
                    <small>Hem tam URL’ler hem de göreli yollar (ör. images/varkas_1.jpg) desteklenir.</small>
                    <div id="marker-images-list" class="image-list"></div>
                </div>
                
                <div class="form-group">
                    <label for="marker-coordinates">Koordinatlar</label>
                    <input type="text" id="marker-coordinates" readonly>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="marker-public" name="marker-public" checked>
                        Herkese açık (oyuncular görebilir)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="marker-is-port" name="marker-is-port">
                        Liman (deniz yolu erişimi)
                    </label>
                    <small>İşaretlenirse, bu şehir denizle karayolu arasında geçiş noktası olur</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-marker">Vazgeç</button>
                    <button type="submit" id="save-marker">İşareti Oluştur</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal for DM Mode -->
    <div class="modal hidden" id="bulk-import-modal">
        <div class="modal-content">
            <h3>Toplu İşaret İçe Aktarma</h3>
            <div class="form-group">
                <label for="csv-input">CSV Verisi</label>
                <textarea id="csv-input" rows="10" placeholder="name,x,y,type,faction,summary,public
Varkas,1234,987,city,Kuruntar,Eski başkent,true
Thornhold,2000,1500,fortress,Empire,Dağ kalesi,true"></textarea>
                <small>Biçim: name,x,y,type,faction,summary,public (başlık satırı isteğe bağlı)</small>
            </div>
            
            <div class="form-group">
                <label for="csv-file">Ya da CSV dosyası yükle:</label>
                <input type="file" id="csv-file" accept=".csv" />
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-import">Vazgeç</button>
                <button type="button" id="process-import">İşaretleri İçe Aktar</button>
            </div>
        </div>
    </div>

    <!-- Terrain Type Selection Modal -->
    <div class="modal hidden" id="terrain-type-modal">
        <div class="modal-content">
            <h3>Arazi Türü Seç</h3>
            <div class="terrain-options">
                <button type="button" class="terrain-btn road-btn" data-type="road">Yol<br>
                    <small>Daha hızlı</small></button>
                <button type="button" class="terrain-btn difficult-btn" data-type="difficult">Zorlu<br>
                    <small>Daha yavaş</small></button>
                <button type="button" class="terrain-btn forest-btn" data-type="medium">Orta<br>
                    <small>Orta zorluk</small></button>
                <button type="button" class="terrain-btn unpassable-btn" data-type="unpassable">Geçilmez<br>
                    <small>İmkânsız</small></button>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-terrain">Vazgeç</button>
            </div>
        </div>
    </div>

    <!-- Icon Edit Modal -->
    <div class="modal hidden" id="icon-edit-modal">
        <div class="modal-content">
            <h3>Simgeyi Düzenle</h3>
            <div class="form-group">
                <label for="icon-char-input">Özel Simge Karakteri</label>
                <input type="text" id="icon-char-input" maxlength="10" placeholder="Örn. 🏰 veya V">
                <small>Boş bırakırsan varsayılan simge kullanılır.</small>
            </div>
            <div class="form-group">
                <label for="icon-url-input">Veya Simge Görsel URL</label>
                <input type="url" id="icon-url-input" placeholder="https://example.com/icon.png">
                <small>PNG/JPG bir simge URL’si kullanabilirsin (yukarıdakinin yerine geçer)</small>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-icon-modal">Vazgeç</button>
                <button type="button" id="save-icon-modal">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Banner Edit Modal -->
    <div class="modal hidden" id="banner-edit-modal">
        <div class="modal-content">
            <h3>Banner Görselini Ayarla</h3>
            <div class="form-group">
                <label for="banner-url-input">Banner Görsel URL</label>
                <input type="url" id="banner-url-input" placeholder="https://... veya images/ornek.jpg">
                <small>Boş bırakıp Kaydet dersen banner kaldırılır.</small>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-banner-modal">Vazgeç</button>
                <button type="button" id="clear-banner-modal">Bannerı Kaldır</button>
                <button type="button" id="save-banner-modal">Kaydet</button>
            </div>
        </div>
    </div>

    <div class="leaflet-top leaflet-right">
        <div class="leaflet-control-layers leaflet-control" id="overlay-toggles">
            <div class="overlay-segmented" role="group" aria-label="Kaplama görünürlüğü">
                <button type="button" class="route-toggle" aria-pressed="false" aria-label="Rota Planlayıcı" title="Rota Planlayıcı">🗺️</button>
                <button type="button" class="markers-toggle" aria-pressed="true" aria-label="Harita İşaretleri" title="Harita İşaretleri">📍</button>
                <button type="button" data-mode="both" class="active" aria-pressed="true"><span>İkisi</span></button>
                <button type="button" data-mode="regions" aria-pressed="false"><span>Bölgeler</span></button>
                <button type="button" data-mode="borders" aria-pressed="false"><span>Sınırlar</span></button>
                <button type="button" data-mode="none" aria-pressed="false"><span>Kapalı</span></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <!-- Netlify Identity for DM authentication -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="/map/config.js"></script>
    <script src="/map/git-client.js"></script>
    <script src="/map/js/leaflet.tappable.js"></script>
    <script src="/map/js/utils/logger.js"></script>
    <!-- Routing Module Components (load before main routing.js) -->
    <script src="/map/js/routing/terrain-utils.js"></script>
    <script src="/map/js/routing/pathfinding.js"></script>
    <script src="/map/js/routing/graph-builder.js"></script>
    <script src="/map/js/routing/path-naturalizer.js"></script>
    <script src="/map/js/routing/visualizer.js"></script>
    <!-- New Modular Routing Components -->
    <script src="/map/js/routing/route-core.js"></script>
    <script src="/map/js/routing/waypoint-manager.js"></script>
    <script src="/map/js/routing/route-ui.js"></script>
    <script src="/map/js/routing/route-drag-drop.js"></script>
    <!-- Load base TR route-share implementation first (shared logic) -->
    <script src="/map/js/routing/route-share.js"></script>
    <script src="/map/js/routing.js"></script>
    <!-- Internationalization -->
    <script src="js/i18n.js"></script>
    <!-- DM Module Components (TR-specific to keep UI strings localized) -->
    <script src="js/dm-controls.js"></script>
    <script src="js/dm-modals.js"></script>
    <script src="js/dm.js"></script>
    <!-- End DM Module Components -->
    <script src="/map/js/ui.js"></script>
    <script src="/map/js/direct-touch.js"></script>
    <script src="/map/js/markers.js"></script>
    <script src="/map/js/terrain.js"></script>
    <script src="map.js"></script>
        <script>
            // Ensure map and sidebars start below header: set CSS var dynamically
            (function(){
                function setHeaderH(){
                    const h = document.querySelector('.map-header');
                    if (!h) return;
                    const px = h.getBoundingClientRect().height;
                    document.documentElement.style.setProperty('--map-header-h', px + 'px');
                }
                window.addEventListener('load', setHeaderH);
                window.addEventListener('resize', setHeaderH);
                const ro = new ResizeObserver(setHeaderH);
                const hdr = document.querySelector('.map-header');
                if (hdr && ro) ro.observe(hdr);
            })();
        </script>
        <script>
            // PWA install prompt handling (TR)
            let deferredPrompt;
            const installBtn = document.getElementById('pwa-install');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'inline-block';
            });
            installBtn?.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome) {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            });
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').catch(console.error);
                });
            }
            // Show a single Logout button when logged in; on click, logout and refresh without DM
            (function(){
                const LS_DM_KEY = 'nimea.dm';
                const btn = document.getElementById('logout-btn');
                function render(user){
                    if (!btn) return;
                    const loggedIn = !!user;
                    btn.style.display = loggedIn ? 'inline-block' : 'none';
                }
                function refreshedUrlWithoutDm(){
                    try {
                        const url = new URL(location.href);
                        url.searchParams.delete('dm');
                        return url.toString();
                    } catch { return location.href; }
                }
                if (window.netlifyIdentity) {
                    try { render(window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser()); } catch {}
                    window.netlifyIdentity.on('init', render);
                    window.netlifyIdentity.on('login', render);
                    window.netlifyIdentity.on('logout', () => {
                        render(null);
                        try { localStorage.removeItem(LS_DM_KEY); } catch{}
                        location.replace(refreshedUrlWithoutDm());
                    });
                }
                btn && btn.addEventListener('click', () => {
                    try { localStorage.removeItem(LS_DM_KEY); } catch{}
                    if (window.netlifyIdentity && typeof window.netlifyIdentity.logout === 'function') {
                        window.netlifyIdentity.logout();
                        setTimeout(() => location.replace(refreshedUrlWithoutDm()), 1000);
                    } else {
                        location.replace(refreshedUrlWithoutDm());
                    }
                });
            })();
            // Admin can be reached via header Admin link in wiki; no hidden shortcuts on map.
        </script>
</body>
</html>
