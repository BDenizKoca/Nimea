<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nimea Interactive Map</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;700&family=EB+Garamond:wght@400;500;700&display=swap&subset=latin-ext">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="/map/style.css">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-180.png">
    <!-- Theme color variants for better UI on supported browsers -->
    <meta name="theme-color" content="#8b4513" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#2e2216" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <header class="map-header">
        <nav class="map-nav">
            <a href="../" class="nav-link">Home</a>
            <a href="../wiki/" class="nav-link">Wiki</a>
            <h1 class="map-title">Nimea Interactive Map</h1>
            <div class="lang-switch">
                <a href="../../map/">TR</a>
            </div>
            <button id="logout-btn" class="wiki-link">Logout</button>
            <button id="pwa-install" class="wiki-link">Install App</button>
        </nav>
    </header>
    
    <div id="map"></div>

    <div class="map-legend hidden" id="map-legend" role="region" aria-label="Map Legend">
        <h4>Legend</h4>
        <ul>
            <li><span class="legend-swatch legend-road"></span> Road</li>
            <li><span class="legend-swatch legend-difficult"></span> Difficult Terrain</li>
            <li><span class="legend-swatch legend-unpassable"></span> Impassable Terrain</li>
            <li><span class="legend-swatch legend-route"></span> Route</li>
        </ul>
    <div class="legend-note">Scale: 115 px = 50 km</div>
    </div>

    <!-- Overlay segmented control will appear through existing container -->

    <div class="sidebar left-sidebar" id="route-sidebar">
        <button id="close-route-sidebar" class="sidebar-close-btn">&times;</button>
    <h2>Route Planner</h2>
        <div id="route-stops"></div>
        <div id="route-summary"></div>
    </div>

    <div class="sidebar right-sidebar" id="info-sidebar">
        <button id="close-info-sidebar" aria-label="Close">&times;</button>
        <div id="info-content"></div>
    </div>

    <!-- DM Mode Marker Creation Form -->
    <div class="modal hidden" id="marker-creation-modal">
        <div class="modal-content">
            <h3>Create New Marker</h3>
            <form id="marker-form">
                <input type="hidden" id="marker-lat">
                <input type="hidden" id="marker-lng">
                <div class="form-group">
                    <label for="marker-name-tr">Ad (TR) *</label>
                    <input type="text" id="marker-name-tr" name="marker-name-tr" required>
                </div>
                <div class="form-group">
                    <label for="marker-name-en">Name (EN)</label>
                    <input type="text" id="marker-name-en" name="marker-name-en">
                </div>
                
                <div class="form-group">
                    <label for="marker-id">ID *</label>
                    <input type="text" id="marker-id" name="marker-id" required>
                    <small>Auto-generated from name; you can edit it</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-type">Type</label>
                    <select id="marker-type" name="marker-type">
                        <option value="city">City</option>
                        <option value="town">Town</option>
                        <option value="village">Village</option>
                        <option value="fortress">Fortress</option>
                        <option value="ruin">Ruin</option>
                        <option value="landmark">Landmark</option>
                        <option value="dungeon">Dungeon</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon">Custom Icon</label>
                    <div class="icon-input-container">
                        <input type="text" id="marker-icon" name="marker-icon" placeholder="Leave empty for default" maxlength="10">
                        <!-- Emoji suggestions removed -->
                    </div>
                    <small>You can enter a custom icon character if you want</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon-url">Or Custom Image URL</label>
                    <input type="url" id="marker-icon-url" name="marker-icon-url" placeholder="https://example.com/icon.png">
                    <small>You can use a PNG/JPG icon URL (replaces the above value)</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-faction-tr">Cemiyet/Devlet (TR)</label>
                    <input type="text" id="marker-faction-tr" name="marker-faction-tr" placeholder="Aurelius İmparatorluğu">
                </div>
                <div class="form-group">
                    <label for="marker-faction-en">Faction (EN)</label>
                    <input type="text" id="marker-faction-en" name="marker-faction-en" placeholder="Empire of Aurelius">
                </div>

                <div class="form-group">
                    <label for="marker-summary-tr">Özet (TR) *</label>
                    <textarea id="marker-summary-tr" name="marker-summary-tr" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="marker-summary-en">Summary (EN)</label>
                    <textarea id="marker-summary-en" name="marker-summary-en" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="marker-wiki-slug">Wiki Slug</label>
                    <input type="text" id="marker-wiki-slug" name="marker-wiki-slug" placeholder="Optional: e.g., empire-of-aurelius">
                    <small>If provided, links directly to /wiki/&lt;slug&gt;/; otherwise auto-generated.</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-image-url">Add Image URL</label>
                    <div class="image-input-row">
                        <input type="url" id="marker-image-url" placeholder="https://... or images/sample.jpg" class="flex-1" />
                        <button type="button" id="add-image-url">Add</button>
                    </div>
                    <small>Supports both full URLs and relative paths (e.g., images/varkas_1.jpg).</small>
                    <div id="marker-images-list" class="image-list"></div>
                </div>
                
                <div class="form-group">
                    <label for="marker-coordinates">Coordinates</label>
                    <input type="text" id="marker-coordinates" readonly>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="marker-public" name="marker-public" checked>
                        Public (players can see)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="marker-is-port" name="marker-is-port">
                        Port (sea travel access)
                    </label>
                    <small>If checked, this city acts as a gateway between land and sea routes</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-marker">Cancel</button>
                    <button type="submit" id="save-marker">Create Marker</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal for DM Mode -->
    <div class="modal hidden" id="bulk-import-modal">
        <div class="modal-content">
            <h3>Bulk Marker Import</h3>
            <div class="form-group">
                <label for="csv-input">CSV Data</label>
                <textarea id="csv-input" rows="10" placeholder="name,x,y,type,faction,summary,public
Varkas,1234,987,city,Kuruntar,Ancient capital,true
Thornhold,2000,1500,fortress,Empire,Mountain fortress,true"></textarea>
                <small>Format: name,x,y,type,faction,summary,public (header row optional)</small>
            </div>
            
            <div class="form-group">
                <label for="csv-file">Or upload CSV file:</label>
                <input type="file" id="csv-file" accept=".csv" />
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-import">Cancel</button>
                <button type="button" id="process-import">Import Markers</button>
            </div>
        </div>
    </div>

    <!-- Terrain Type Selection Modal -->
    <div class="modal hidden" id="terrain-type-modal">
        <div class="modal-content">
            <h3>Select Terrain Type</h3>
            <div class="terrain-options">
                <button type="button" class="terrain-btn road-btn" data-type="road">Road<br>
                    <small>Faster</small></button>
                <button type="button" class="terrain-btn difficult-btn" data-type="difficult">Difficult<br>
                    <small>Slower</small></button>
                <button type="button" class="terrain-btn forest-btn" data-type="medium">Medium<br>
                    <small>Medium difficulty</small></button>
                <button type="button" class="terrain-btn unpassable-btn" data-type="unpassable">Impassable<br>
                    <small>Impossible</small></button>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-terrain">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Icon Edit Modal -->
    <div class="modal hidden" id="icon-edit-modal">
        <div class="modal-content">
            <h3>Edit Icon</h3>
            <div class="form-group">
                <label for="icon-char-input">Custom Icon Character</label>
                <input type="text" id="icon-char-input" maxlength="10" placeholder="e.g., 🏰 or V">
                <small>Leave empty to use the default icon.</small>
            </div>
            <div class="form-group">
                <label for="icon-url-input">Or Icon Image URL</label>
                <input type="url" id="icon-url-input" placeholder="https://example.com/icon.png">
                <small>You can use a PNG/JPG icon URL (overrides the character)</small>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-icon-modal">Cancel</button>
                <button type="button" id="save-icon-modal">Save</button>
            </div>
        </div>
    </div>

    <!-- Banner Edit Modal -->
    <div class="modal hidden" id="banner-edit-modal">
        <div class="modal-content">
            <h3>Set Banner Image</h3>
            <div class="form-group">
                <label for="banner-url-input">Banner Image URL</label>
                <input type="url" id="banner-url-input" placeholder="https://... or images/sample.jpg">
                <small>Leave empty and Save to clear the banner.</small>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-banner-modal">Cancel</button>
                <button type="button" id="clear-banner-modal">Clear Banner</button>
                <button type="button" id="save-banner-modal">Save</button>
            </div>
        </div>
    </div>

    <div class="leaflet-top leaflet-right">
        <div class="leaflet-control-layers leaflet-control" id="overlay-toggles">
            <div class="overlay-segmented" role="group" aria-label="Overlay visibility">
                <button type="button" class="route-toggle" aria-pressed="false" aria-label="Route Planner" title="Route Planner">🗺️</button>
                <button type="button" class="markers-toggle" aria-pressed="true" aria-label="Map Markers" title="Map Markers">📍</button>
                <button type="button" data-mode="both" class="active" aria-pressed="true"><span>Both</span></button>
                <button type="button" data-mode="regions" aria-pressed="false"><span>Regions</span></button>
                <button type="button" data-mode="borders" aria-pressed="false"><span>Borders</span></button>
                <button type="button" data-mode="none" aria-pressed="false"><span>Off</span></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <!-- Turf.js for DM terrain merge operations -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <!-- Netlify Identity for DM authentication -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="/map/config.js"></script>
    <script src="/map/git-client.js"></script>
    <script src="/map/js/leaflet.tappable.js"></script>
    <script src="/map/js/utils/logger.js"></script>
    <!-- Routing Module Components (load before main routing.js) -->
    <script src="/map/js/routing/terrain-utils.js"></script>
    <script src="/map/js/routing/pathfinding.js"></script>
    <script src="/map/js/routing/graph-builder.js"></script>
    <script src="/map/js/routing/path-naturalizer.js"></script>
    <script src="/map/js/routing/visualizer.js"></script>
    <!-- New Modular Routing Components -->
    <script src="/map/js/routing/route-core.js"></script>
    <script src="/map/js/routing/waypoint-manager.js"></script>
    <script src="/map/js/routing/route-ui.js"></script>
    <script src="/map/js/routing/route-drag-drop.js"></script>
    <!-- Load base TR route-share implementation first (shared logic) -->
    <script src="/map/js/routing/route-share.js"></script>
    <script src="/map/js/routing.js"></script>
    <!-- Internationalization -->
    <script src="js/i18n.js"></script>
    <!-- DM Module Components (Shared - language-agnostic with i18n) -->
    <script src="js/dm-controls.js"></script>
    <script src="js/dm-modals.js"></script>
    <script src="js/dm.js"></script>
    <!-- End DM Module Components -->
    <script src="/map/js/ui.js"></script>
    <script src="/map/js/direct-touch.js"></script>
    <script src="/map/js/markers.js"></script>
    <script src="/map/js/terrain.js"></script>
    <script src="/map/map.js"></script>
        <script>
            // Ensure map and sidebars start below header: set CSS var dynamically
            (function(){
                function setHeaderH(){
                    const h = document.querySelector('.map-header');
                    if (!h) return;
                    const px = h.getBoundingClientRect().height;
                    document.documentElement.style.setProperty('--map-header-h', px + 'px');
                }
                window.addEventListener('load', setHeaderH);
                window.addEventListener('resize', setHeaderH);
                const ro = new ResizeObserver(setHeaderH);
                const hdr = document.querySelector('.map-header');
                if (hdr && ro) ro.observe(hdr);
            })();
        </script>
        <script>
            // PWA install prompt handling (EN)
            let deferredPrompt;
            const installBtn = document.getElementById('pwa-install');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'inline-block';
            });
            installBtn?.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome) {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            });
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').catch(console.error);
                });
            }
            // Show a single Logout button when logged in; on click, logout and refresh without DM
            (function(){
                const LS_DM_KEY = 'nimea.dm';
                const btn = document.getElementById('logout-btn');
                function render(user){
                    if (!btn) return;
                    const loggedIn = !!user;
                    btn.style.display = loggedIn ? 'inline-block' : 'none';
                }
                function refreshedUrlWithoutDm(){
                    try {
                        const url = new URL(location.href);
                        url.searchParams.delete('dm');
                        return url.toString();
                    } catch { return location.href; }
                }
                if (window.netlifyIdentity) {
                    try { render(window.netlifyIdentity.currentUser && window.netlifyIdentity.currentUser()); } catch {}
                    window.netlifyIdentity.on('init', render);
                    window.netlifyIdentity.on('login', render);
                    window.netlifyIdentity.on('logout', () => {
                        render(null);
                        try { localStorage.removeItem(LS_DM_KEY); } catch{}
                        location.replace(refreshedUrlWithoutDm());
                    });
                }
                btn && btn.addEventListener('click', () => {
                    try { localStorage.removeItem(LS_DM_KEY); } catch{}
                    if (window.netlifyIdentity && typeof window.netlifyIdentity.logout === 'function') {
                        window.netlifyIdentity.logout();
                        setTimeout(() => location.replace(refreshedUrlWithoutDm()), 1000);
                    } else {
                        location.replace(refreshedUrlWithoutDm());
                    }
                });
            })();
            // Admin can be reached via header Admin link in wiki; no hidden shortcuts on map.
        </script>
</body>
</html>

